<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenPDF</title>
  <style>
    /* Global styles */
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      line-height: 1.6;
    }
    
    .container {
      width: 100%;
      max-width: 40rem;
      margin: 0 auto;
      padding: 2rem;
      box-sizing: border-box;
    }

    #app-content {
      width: 100%;
    }

    h1 {
      margin-bottom: 1.5rem;
    }

    .examples {
      margin-top: 2rem;
      padding: 1rem;
      background-color: #f5f5f5;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
    }

    /* Alert component */
    #alert-container {
      width: 100%;
    }
    
    .alert {
      width: 100%;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
      box-sizing: border-box;
    }
    
    .alert-error {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }
    
    .alert-warning {
      background-color: #fff8e1;
      color: #f57f17;
      border: 1px solid #ffe082;
    }
    
    .alert-success {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #a5d6a7;
    }

    /* DOI form */
    .doi-form {
      margin: 2rem 0;
      width: 100%;
    }
    
    input {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    button {
      background: #4a69bd;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
    }
    button:hover {
      background: #1e3799;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="app-content">
      <h1>OpenPDF</h1>
      <h3>Find the PDF for Open Access publications</h3>
      
      <div id="alert-container"></div>
      
      <p>
        Enter a DOI or DOI URL to directly get the full-text PDF. For non-Open Access publications, you'll be redirected to the publisher's website.
      </p>

      <form id="doi-form" class="doi-form">
        <input
          type="text"
          id="doi-input"
          placeholder="Enter 10.4018/IJWLTT.20211101.oa4 or https://doi.org/10.4018/IJWLTT.20211101.oa4"
          required
        />
        <button type="submit">Find PDF</button>
      </form>
    </div>
  </div>

  <script>
    // DOI regex for validation
    const doiRegex = () => {
      return /\b(10\.[0-9]{3,}(?:\.[0-9]+)*\/(?:(?![\"&\'])\S)+)\b/gi;
    };

    // Get URL parameters helper
    function getUrlParams() {
      const searchParams = new URLSearchParams(window.location.search);
      return {
        error: searchParams.get('error'),
        doi: searchParams.get('doi'),
        success: searchParams.get('success'),
        message: searchParams.get('message')
      };
    }

    // Show alert message
    function showAlert(message, type = 'error') {
      const alertContainer = document.getElementById('alert-container');
      alertContainer.innerHTML = `
        <div class="alert alert-${type}">
          ${message}
        </div>
      `;
    }

    // Handle form submission
    document.getElementById('doi-form').addEventListener('submit', async function(event) {
      event.preventDefault();
      
      const doiInput = document.getElementById('doi-input').value.trim();
      
      // Validate DOI
      const match = doiInput.match(doiRegex());
      if (!match) {
        showAlert('The provided input does not appear to be a valid DOI. Please check and try again.');
        return;
      }
      
      const extractedDoi = match[0];
      
      try {
        // Show loading state
        showAlert('Looking up DOI...', 'success');
        
        // Fetch data from OpenAlex
        const work = await getOpenAlexWork(extractedDoi);
        const pdfUrl = await findPdfUrl(work);
        const redirectDelay = 500;
        
        if (!pdfUrl) {
          // Check if there is a primary location URL for non-Open Access publications
          const primaryUrl = work.primary_location?.landing_page_url;
          if (primaryUrl) {
            showAlert(`This article is not Open Access. Opening publisher's website...`, 'warning');
            setTimeout(() => {
              window.open(primaryUrl, '_self');
            }, redirectDelay);
            return;
          }
          showAlert(`No PDF found for DOI: ${extractedDoi}. The article might not have an open access version available.`);
          return;
        }
        
        // Redirect to PDF
        showAlert(`PDF found. Opening...`, 'success');
        setTimeout(() => {
          window.open(pdfUrl, '_self');
        }, redirectDelay);
        
      } catch (error) {
        showAlert(`Failed to resolve DOI: ${extractedDoi}. ${error.message || 'Unknown error'}`);
      }
    });

    // Handle DOM content loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Check URL parameters
      const params = getUrlParams();
      
      if (params.doi) {
        document.getElementById('doi-input').value = params.doi;
      }
      
      if (params.success === 'true' && params.doi) {
        showAlert(`Successfully found PDF for DOI: ${params.doi}`, 'success');
      } else if (params.error) {
        let alertMessage = '';
        switch(params.error) {
          case 'invalid-doi':
            alertMessage = 'The provided input does not appear to be a valid DOI. Please check and try again.';
            break;
          case 'no-pdf-found':
            alertMessage = `No PDF or publisher location found for DOI: ${params.doi || 'Unknown'}. The article might not be indexed correctly.`;
            break;
          case 'failed-to-resolve':
            alertMessage = `Failed to resolve DOI: ${params.doi || 'Unknown'}. ${params.message || 'Please try again later.'}`;
            break;
          default:
            alertMessage = 'An unknown error occurred. Please try again.';
        }
        showAlert(alertMessage);
      }
      
      // Check if we have a DOI in the hash
      const hashDoi = window.location.hash.replace('#', '');
      if (hashDoi) {
        const match = decodeURIComponent(hashDoi).match(doiRegex());
        if (match) {
          document.getElementById('doi-input').value = match[0];
          document.getElementById('doi-form').dispatchEvent(new Event('submit'));
        }
      }
    });

    // OpenAlex API functions
    async function getOpenAlexWork(doi) {
      const encodedDoi = encodeURIComponent(doi);
      try {
        const response = await fetch(`https://api.openalex.org/works/https://doi.org/${encodedDoi}`);
        
        if (!response.ok) {
          if (response.status === 404) {
            throw new Error(`DOI not found in OpenAlex database (${response.status})`);
          } else if (response.status === 429) {
            throw new Error(`OpenAlex API rate limit exceeded (${response.status}). Please try again later.`);
          } else if (response.status >= 500) {
            throw new Error(`OpenAlex server error (${response.status}). Please try again later.`);
          } else {
            throw new Error(`Failed to fetch from OpenAlex: ${response.status}`);
          }
        }
        
        const data = await response.json();
        
        // Check if OpenAlex found the work but it's a placeholder/error response
        if (data.id === null || data.error) {
          throw new Error(`Article metadata not available in OpenAlex: ${data.error || 'Unknown error'}`);
        }
        
        return data;
      } catch (error) {
        // Enhance network/fetch errors
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          throw new Error(`Network error when connecting to OpenAlex. Please check your internet connection.`);
        }
        throw error;
      }
    }

    async function findPdfUrl(work) {
      // Use OpenAlex's best_oa_location pdf_url if available
      if (work.best_oa_location?.pdf_url) {
        return work.best_oa_location.pdf_url;
      }
      
      return null;
    }
  </script>
</body>
</html>