<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenPDF - DOI to PDF Resolver</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.3.1/pdfobject.min.js" integrity="sha512-okdYHqKDXlxPqa15xRbGTv/Dg6TxskmMjtQWlIDMFbblo9/M2uPNowgmBuiDcGMfkE6pWtqPr9PuEWsTPyKWAw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    /* Global styles */
    body {
      font-family: system-ui, sans-serif;
      max-width: 40rem;
      margin: 0 auto;
      padding: 2rem;
      line-height: 1.6;
    }

    h1 {
      margin-bottom: 1.5rem;
    }

    .examples {
      margin-top: 2rem;
      padding: 1rem;
      background-color: #f5f5f5;
      border-radius: 4px;
    }

    /* Alert component */
    .alert {
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
    }
    .alert-error {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }
    .alert-success {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #a5d6a7;
    }

    /* DOI form */
    .doi-form {
      margin: 2rem 0;
    }
    input {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    button {
      background: #4a69bd;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
    }
    button:hover {
      background: #1e3799;
    }

    /* PDF viewer styles */
    #pdf-container {
      height: 100vh;
      width: 100%;
      position: fixed;
      top: 0;
      left: 0;
      background: white;
      z-index: 100;
      display: none;
    }
    #pdf-viewer {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
    .fallback {
      padding: 20px;
      text-align: center;
    }
    .controls {
      position: fixed;
      top: 0;
      right: 0;
      background: rgba(255,255,255,0.8);
      padding: 10px;
      border-radius: 0 0 0 10px;
      z-index: 1000;
    }
    .controls a {
      margin: 0 10px;
      color: #0066cc;
      text-decoration: none;
    }
    .controls a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="app-content">
    <h1>OpenPDF - DOI to PDF Resolver</h1>
    
    <div id="alert-container"></div>
    
    <p>
      Enter a DOI (e.g., <code>10.4018/IJWLTT.20211101.oa4</code>) or DOI URL (e.g.,
      <code>https://doi.org/10.4018/IJWLTT.20211101.oa4</code>) to find the full-text PDF.
    </p>

    <form id="doi-form" class="doi-form">
      <input
        type="text"
        id="doi-input"
        placeholder="Enter DOI or DOI URL"
        required
      />
      <button type="submit">Find PDF</button>
    </form>
  </div>

  <div id="pdf-container">
    <div class="controls">
      <a href="#" id="home-link" title="Return to home">Home</a>
      <a href="#" id="new-tab-link" target="_blank" title="Open PDF in new tab">Open in new tab</a>
    </div>
    
    <div id="pdf-viewer">
      <div class="fallback">
        <p>Unable to display PDF directly. <a id="fallback-link" href="#" target="_blank">Click here to open the PDF in a new tab</a>.</p>
      </div>
    </div>
  </div>

  <script>
    // DOI regex for validation
    const doiRegex = () => {
      return /\b(10\.[0-9]{3,}(?:\.[0-9]+)*\/(?:(?![\"&\'])\S)+)\b/gi;
    };

    // Get URL parameters helper
    function getUrlParams() {
      const searchParams = new URLSearchParams(window.location.search);
      return {
        error: searchParams.get('error'),
        doi: searchParams.get('doi'),
        success: searchParams.get('success'),
        message: searchParams.get('message')
      };
    }

    // Show alert message
    function showAlert(message, type = 'error') {
      const alertContainer = document.getElementById('alert-container');
      alertContainer.innerHTML = `
        <div class="alert alert-${type}">
          ${message}
        </div>
      `;
    }

    // Handle form submission
    document.getElementById('doi-form').addEventListener('submit', async function(event) {
      event.preventDefault();
      
      const doiInput = document.getElementById('doi-input').value.trim();
      
      // Validate DOI
      const match = doiInput.match(doiRegex());
      if (!match) {
        showAlert('The provided input does not appear to be a valid DOI. Please check and try again.');
        return;
      }
      
      const extractedDoi = match[0];
      
      try {
        // Show loading state
        showAlert('Looking up DOI...', 'success');
        
        // Fetch data from OpenAlex
        const work = await getOpenAlexWork(extractedDoi);
        const pdfUrl = await findPdfUrl(work);
        
        if (!pdfUrl) {
          showAlert(`No PDF found for DOI: ${extractedDoi}. The article might not have an open access version available.`);
          return;
        }
        
        // Display PDF
        showPdfViewer(pdfUrl, work.title || 'PDF Viewer');
        
      } catch (error) {
        showAlert(`Failed to resolve DOI: ${extractedDoi}. ${error.message || 'Unknown error'}`);
      }
    });

    // Handle DOM content loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Check URL parameters
      const params = getUrlParams();
      
      if (params.doi) {
        document.getElementById('doi-input').value = params.doi;
      }
      
      if (params.success === 'true' && params.doi) {
        showAlert(`Successfully found PDF for DOI: ${params.doi}`, 'success');
      } else if (params.error) {
        let alertMessage = '';
        switch(params.error) {
          case 'invalid-doi':
            alertMessage = 'The provided input does not appear to be a valid DOI. Please check and try again.';
            break;
          case 'no-pdf-found':
            alertMessage = `No PDF found for DOI: ${params.doi || 'Unknown'}. The article might not have an open access version available.`;
            break;
          case 'failed-to-resolve':
            alertMessage = `Failed to resolve DOI: ${params.doi || 'Unknown'}. ${params.message || 'Please try again later.'}`;
            break;
          default:
            alertMessage = 'An unknown error occurred. Please try again.';
        }
        showAlert(alertMessage);
      }
      
      // Check if we have a DOI in the hash
      const hashDoi = window.location.hash.replace('#', '');
      if (hashDoi) {
        const match = decodeURIComponent(hashDoi).match(doiRegex());
        if (match) {
          document.getElementById('doi-input').value = match[0];
          document.getElementById('doi-form').dispatchEvent(new Event('submit'));
        }
      }
    });

    // Home link functionality
    document.getElementById('home-link').addEventListener('click', function(event) {
      event.preventDefault();
      hidePdfViewer();
    });

    // OpenAlex API functions
    async function getOpenAlexWork(doi) {
      const encodedDoi = encodeURIComponent(doi);
      try {
        const response = await fetch(`https://api.openalex.org/works/https://doi.org/${encodedDoi}`);
        
        if (!response.ok) {
          if (response.status === 404) {
            throw new Error(`DOI not found in OpenAlex database (${response.status})`);
          } else if (response.status === 429) {
            throw new Error(`OpenAlex API rate limit exceeded (${response.status}). Please try again later.`);
          } else if (response.status >= 500) {
            throw new Error(`OpenAlex server error (${response.status}). Please try again later.`);
          } else {
            throw new Error(`Failed to fetch from OpenAlex: ${response.status}`);
          }
        }
        
        const data = await response.json();
        
        // Check if OpenAlex found the work but it's a placeholder/error response
        if (data.id === null || data.error) {
          throw new Error(`Article metadata not available in OpenAlex: ${data.error || 'Unknown error'}`);
        }
        
        return data;
      } catch (error) {
        // Enhance network/fetch errors
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          throw new Error(`Network error when connecting to OpenAlex. Please check your internet connection.`);
        }
        throw error;
      }
    }

    async function findPdfUrl(work) {
      // Use OpenAlex's best_oa_location pdf_url if available
      if (work.best_oa_location?.pdf_url) {
        return work.best_oa_location.pdf_url;
      }
      
      return null;
    }

    // PDF viewer functions
    function showPdfViewer(pdfUrl, title) {
      // Update page title
      document.title = title;
      
      // Update links
      document.getElementById('new-tab-link').href = pdfUrl;
      document.getElementById('fallback-link').href = pdfUrl;
      
      // Show PDF container
      document.getElementById('app-content').style.display = 'none';
      document.getElementById('pdf-container').style.display = 'block';
      
      // Update URL
      updateURL(pdfUrl);
      
      // Embed PDF
      PDFObject.embed(pdfUrl, '#pdf-viewer');
    }

    function hidePdfViewer() {
      document.getElementById('app-content').style.display = 'block';
      document.getElementById('pdf-container').style.display = 'none';
      document.title = 'OpenPDF - DOI to PDF Resolver';
      
      // Update URL to remove hash
      history.pushState('', document.title, window.location.pathname + window.location.search);
    }

    function updateURL(pdfUrl) {
      // Extract DOI from the PDF URL if possible, otherwise use current DOI input
      const doiInput = document.getElementById('doi-input').value.trim();
      const match = doiInput.match(doiRegex());
      if (match) {
        const extractedDoi = match[0];
        window.location.hash = encodeURIComponent(extractedDoi);
      }
    }
  </script>
</body>
</html>